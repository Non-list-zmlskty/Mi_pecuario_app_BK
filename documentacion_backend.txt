"Camila, realicé estos cambios debido a que consideré que la estructura y organización anterior podía verse muy hostil y larga, 
además de incomprensible por momentos. Busco que entiendas de la mejor forma todo lo que será dado en la organización de esta documentación.
 Cualquier cosa estaré pendiente a tu respuesta, pregunta todo y más sobre lo que entiendas y no entiendas o encuentres irrazonable" -
  sin mucha dedicación, Juan.

DOCUMENTACIÓN BACKEND MIPECUARIO (2024)
========================================

# INTRODUCCIÓN GENERAL
----------------------
Esta documentación está pensada para personas que manejan bases de datos y tienen poco o ningún conocimiento sobre cómo funciona un backend, especialmente en este proyecto. Aquí te explico de forma sencilla cómo se conecta y organiza el backend con la base de datos, cómo se comunican, y por qué tu trabajo es fundamental para que todo funcione correctamente.

# ¿QUÉ ES EL BACKEND?
---------------------
El backend es la parte del sistema que se encarga de recibir las solicitudes de la app o la web, procesarlas y devolver respuestas. Por ejemplo, cuando alguien registra un animal, el backend recibe esos datos y los guarda en la base de datos. El backend también consulta la base de datos para mostrar información en la app.

# 1. ESTRUCTURA Y ORGANIZACIÓN DEL PROYECTO
--------------------------------------------
- El backend está modularizado usando Blueprints de Flask.
- Cada dominio (auth, user, lote, animal) tiene su propio archivo en `routes/`.
- Modelos SQLAlchemy en `models/models.py`.
- Conexión a base de datos centralizada en `db/session.py` usando variables de entorno (`.env`).
- Utilidades (JWT, email, etc.) en `utils/`.
- Validaciones en `schemas/`.
- Archivos legacy solo como referencia.

# 2. ¿CÓMO SE CONECTA EL BACKEND A LA BASE DE DATOS?
----------------------------------------------------
El backend usa un archivo llamado `.env` donde se guardan los datos de conexión (usuario, contraseña, nombre de la base, etc.). Así, si cambias algo en la base de datos, solo tienes que actualizar este archivo.

Ejemplo de `.env`:
```
DB_USER=tu_usuario
DB_PASSWORD=tu_contraseña
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=MiPecuarioWed
JWT_SECRET_KEY=tu_clave_secreta
```
El archivo `db/session.py` lee estos datos y permite que el backend hable con la base de datos.

# 3. ¿CÓMO SE RELACIONA TU TRABAJO CON EL BACKEND?
--------------------------------------------------
Cada vez que creas o modificas una tabla, el backend debe saberlo para poder guardar o leer datos correctamente. Por eso, los modelos en `models/models.py` deben estar sincronizados con la estructura real de la base de datos.

Por ejemplo:
- Si agregas un campo nuevo a la tabla `Lote`, hay que agregarlo también en el modelo `Lote` en Python.
- Si cambias el tipo de dato de un campo, hay que actualizarlo en el modelo.

# 4. ¿CÓMO FUNCIONAN LOS ENDPOINTS?
------------------------------------
Un endpoint es como una "puerta" por donde la app pide o envía información. Por ejemplo:
- `/api/animal/registrar`: la app envía los datos de un nuevo animal y el backend los guarda en la base de datos.
- `/api/animal/mis-fichas`: la app pide la lista de fichas (lotes) y el backend responde con los datos que están en la base.

Todos los endpoints importantes están protegidos con un sistema de seguridad llamado JWT (token), para que solo usuarios autenticados puedan acceder.

# 5. AUTENTICACIÓN Y TOKENS JWT
-------------------------------
- Los tokens JWT ahora usan la clave secreta y expiraciones definidas en `.env`.
- El access token dura 12 horas, el refresh token 30 días.
- El backend lee la clave secreta con `os.environ.get("JWT_SECRET_KEY")`.
- El frontend puede usar el mismo token varias veces hasta que expire.
- Se corrigió el bug donde el token expiraba demasiado rápido.
- El refresh token permite renovar el access token sin reloguear.

# 6. BASE DE DATOS Y MODELOS
----------------------------
- El campo `cantidad` en la tabla `Lote` ahora se actualiza correctamente y es usado para cálculos de peso.
- Se corrigieron registros nulos en `cantidad` con un update masivo.
- Los modelos reflejan la estructura real de la base de datos.
- Los cálculos de peso promedio individual y total usan correctamente los datos de `PesoLote` y `cantidad`.

# 7. ENDPOINTS Y LÓGICA DE NEGOCIO
----------------------------------
- `/api/animal/registrar`: Registra un lote y animales, guarda la cantidad.
- `/api/animal/mis-fichas`: Devuelve fichas del usuario, incluye cálculos de peso.
- `/api/animal/ficha/<lote_id>`: Devuelve detalle y cálculos de una ficha/lote.
- `/api/animal/lote/<lote_id>/pesos`: Devuelve peso total y promedio individual, usando peso real o estimado si no hay registro.
- `/api/lote/registrar`: Registra un nuevo lote.
- `/api/lote/mis-lotes`: Devuelve lotes del usuario.
- `/api/user/profile`: Devuelve perfil del usuario autenticado.
- Todos los endpoints protegidos usan el decorador `@token_required` que valida el JWT.

# 8. MANEJO DE ERRORES Y SEGURIDAD
----------------------------------
- Mejor manejo de errores en autenticación (401 para token expirado, inválido o revocado).
- Uso de blocklist para tokens revocados (logout).
- Validación de datos de entrada con Pydantic en `schemas/`.
- Manejo de errores de base de datos y lógica de negocio.

# 9. CONFIGURACIÓN Y VARIABLES DE ENTORNO
-----------------------------------------
- `.env` contiene todas las variables sensibles y de configuración.
- `config.py` y utilidades leen las variables desde el entorno.
- Ejemplo de `.env`:
  ```
  DB_USER=...
  DB_PASSWORD=...
  JWT_SECRET_KEY=...
  ```

# 10. RECOMENDACIONES Y BUENAS PRÁCTICAS
----------------------------------------
- Siempre registrar la cantidad de animales al crear un lote.
- Mantener sincronizados los relojes del servidor y clientes para evitar problemas de expiración de tokens.
- Usar Postman o herramientas similares para probar los endpoints.
- Revisar los logs del backend para depurar errores de autenticación o datos.
- Si agregas o quitas animales de un lote, actualiza el campo `cantidad`.
- Si tienes dudas sobre cómo se usan los datos en el backend, pregunta al equipo.
- Usa herramientas como DBeaver o phpMyAdmin para revisar los datos y asegurarte de que todo esté bien.

# 11. CAMBIOS RECIENTES Y BUGS SOLUCIONADOS
-------------------------------------------
- Centralización de la clave secreta JWT y expiraciones.
- Corrección de bug de expiración temprana de tokens.
- Actualización masiva de campo `cantidad` en lotes existentes.
- Mejoras en la consulta y cálculo de pesos.
- Refactorización de rutas y modularización.
- Documentación y ejemplos actualizados para el equipo frontend.

# 12. EJEMPLOS DE USO Y RESPUESTAS
----------------------------------
- Ver ejemplos de requests y responses en los endpoints de animal y lote.
- El frontend debe consumir los campos tal como los envía el backend (`peso_individual_estimado`, `peso_general_lote`, etc.).

# 13. CONTACTO Y SOPORTE
------------------------
- Si tienes dudas, revisa esta documentación y los comentarios en el código.
- Pregunta cualquier cosa al equipo de backend para aclarar lógica o estructura.

# 14. MENSAJE FINAL PARA CAMILA
-------------------------------
Camila PORFAVOR si terminaste de leer todo esto ESCRIBEME el codigo 1212424 para saber que entendiste y leiste esta documentacion dedicada para tu entendimiento sobre este proyecto en lo que respecta a tu parte e involucracion con esta.

FIN DE DOCUMENTACIÓN ACTUALIZADA (JUNIO 2025)